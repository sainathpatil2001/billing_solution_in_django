{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediBill Pro</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <style>
        :root {
            --sidebar-width: 220px;
            --primary-bg: #f3f4f6;
            --sidebar-bg: #1e293b;
            --sidebar-text: #e2e8f0;
            --accent-color: #3b82f6;
            --card-bg: #ffffff;
            --font-family: 'Inter', sans-serif;
            --border-color: #e5e7eb;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--primary-bg);
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            font-size: 0.85rem;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            display: flex;
            flex-direction: column;
            height: 100vh;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        .brand-section {
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .brand-logo {
            width: 28px;
            height: 28px;
            background: var(--accent-color);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
        }

        .brand-text {
            font-weight: 600;
            font-size: 1rem;
            letter-spacing: 0.5px;
        }

        .nav-menu {
            flex: 1;
            padding: 1rem 0.75rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            padding: 0.6rem 0.75rem;
            color: #94a3b8;
            text-decoration: none;
            border-radius: 6px;
            transition: all 0.2s;
            font-weight: 500;
            font-size: 0.85rem;
        }

        .nav-item:hover, .nav-item.active {
            background-color: rgba(255,255,255,0.1);
            color: white;
        }

        .nav-item.active {
            background-color: var(--accent-color);
        }

        .nav-item i {
            font-size: 1rem;
        }

        .user-section {
            padding: 0.75rem;
            border-top: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.2);
        }

        .business-badge-sidebar {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            padding: 0.4rem;
            border-radius: 6px;
        }

        .business-logo-mini {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: white;
            object-fit: contain;
            border: 2px solid rgba(255,255,255,0.2);
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        .billing-layout {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 0.5rem;
            gap: 0.5rem;
        }

        /* Top Bar (Search & Info) */
        .top-bar {
            flex-shrink: 0;
            display: flex;
            gap: 0.75rem;
            align-items: center;
            background: var(--card-bg);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
        }

        .search-container {
            flex: 1;
            position: relative;
            z-index: 100;
        }
        
        .search-input {
            width: 100%;
            padding: 0.4rem 0.75rem 0.4rem 2rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: #f8fafc;
            font-size: 0.85rem;
            transition: all 0.2s;
            height: 32px;
        }

        .search-input:focus {
            background: white;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            font-size: 0.8rem;
        }

        .shortcut-badge {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            background: #e2e8f0;
            padding: 0.1rem 0.4rem;
            border-radius: 4px;
            font-size: 0.65rem;
            color: #64748b;
            font-weight: 600;
        }

        .search-results {
            position: absolute;
            top: calc(100% + 5px);
            left: 0;
            right: 0;
            background: white;
            border-radius: 6px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 50;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }

        .search-result-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
            transition: background 0.1s;
        }

        .search-result-item:hover, .search-result-item.active {
            background: #f1f5f9;
            border-left: 3px solid var(--accent-color);
        }

        /* Items Table Area */
        .items-area {
            flex: 1;
            background: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .table-wrapper {
            flex: 1;
            overflow: auto;
        }

        .table thead th {
            background: #f8fafc;
            color: #64748b;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.5px;
            padding: 0.6rem;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .table tbody td {
            vertical-align: middle;
            padding: 0.35rem 0.6rem;
            color: #334155;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.8rem;
        }

        /* Bottom Summary Panel */
        .summary-panel {
            min-height: 160px;
            height: auto;
            background: var(--card-bg);
            border-radius: 8px 8px 0 0; /* Rounded top only if bottom aligned? Keep all round */
            border-top: 1px solid var(--border-color);
            padding: 1rem;
            display: flex;
            gap: 1.5rem;
            box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.04);
            flex-shrink: 0;
            z-index: 20;
        }

        .summary-col {
            flex: 1;
            /* Align top */
        }

        .summary-col-actions {
            flex: 0 0 240px;
            background: #f8fafc;
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .grand-total-box {
            background: var(--accent-color);
            background: linear-gradient(135deg, var(--accent-color), #2563eb);
            color: white;
            padding: 0.75rem;
            border-radius: 8px;
            margin: 0.5rem 0;
            text-align: center;
            box-shadow: 0 4px 10px rgba(37, 99, 235, 0.2);
        }

        .form-label-sm {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 0.15rem;
        }

        .form-control-desktop {
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            height: 28px;
        }
        
        .form-control-desktop:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
            font-size: 0.8rem;
            color: #475569;
        }

        .grand-total {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent-color);
            margin-top: 0.25rem;
            padding-top: 0.25rem;
            border-top: 1px solid #cbd5e1;
        }

        .status-pill {
            padding: 0.15rem 0.5rem;
            border-radius: 50px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        /* Misc */
        .app-branding {
            position: absolute;
            bottom: 5px;
            right: 15px;
            font-size: 0.7rem;
            color: #cbd5e1;
            pointer-events: none;
            z-index: 100;
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        @media print {
            .sidebar, .top-bar .search-container, .top-bar .btn, .d-print-none {
                display: none !important;
            }
            .main-content {
                height: auto;
                overflow: visible;
            }
            body {
                background: white;
                height: auto;
                overflow: visible;
            }
            .billing-layout {
                padding: 0;
            }
            .table-wrapper {
                overflow: visible;
            }
            .summary-panel {
                break-inside: avoid;
            }
            /* Hide specific buttons in table */
            .bi-trash, button {
                display: none !important;
            }
        }
    </style>
</head>
<body>

    <!-- Desktop Sidebar -->
    <div class="sidebar">
        <div class="brand-section">
            <div class="brand-logo">
                <i class="bi bi-wallet2"></i>
            </div>
            <div class="brand-text">MediBill Pro</div>
        </div>

        <div class="nav-menu">
            <a href="/billing/" class="nav-item active">
                <i class="bi bi-receipt-cutoff"></i>
                <span>New Invoice</span>
            </a>
            <a href="/billing/bills/" class="nav-item">
                <i class="bi bi-clock-history"></i>
                <span>History & Search</span>
            </a>
            <a href="/inventory/inventory_management/" class="nav-item">
                <i class="bi bi-box-seam"></i>
                <span>Inventory</span>
            </a>
            <a href="/billing/backup/" class="nav-item">
                <i class="bi bi-database-check"></i>
                <span>Backup & Restore</span>
            </a>
            <a href="/billing/business-settings/" class="nav-item">
                <i class="bi bi-gear"></i>
                <span>Settings</span>
            </a>
        </div>

        <div class="user-section">
            <div class="business-badge-sidebar">
                {% if business_info.logo %}
                <img src="{{ business_info.logo.url }}" alt="Logo" class="business-logo-mini">
                {% else %}
                <div class="business-logo-mini d-flex align-items-center justify-content-center text-primary fw-bold">
                    {{ business_info.company_name|slice:":1" }}
                </div>
                {% endif %}
                <div class="d-flex flex-column text-truncate">
                    <span class="small fw-bold text-white text-truncate">{{ business_info.company_name|default:"My Business" }}</span>
                    <span class="small text-muted" id="liveClock" style="font-size: 0.7rem;">Loading...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Workspace -->
    <div class="main-content">
        <div class="billing-layout">
            
            <!-- Top Search Bar -->
            <div class="top-bar">
                <div class="search-container">
                    <i class="bi bi-search search-icon"></i>
                    <input type="text" class="search-input" id="productSearch" placeholder="Search product by name, code or scan barcode..." autofocus>
                    <span class="shortcut-badge">Ctrl + F</span>
                    
                    <div class="search-results" style="display: none;"></div>
                </div>
                
                <div class="d-flex align-items-center gap-2 border-start ps-3">
                    <span class="small fw-bold text-muted text-uppercase" style="font-size: 0.65rem;">Tax Mode:</span>
                    <div class="btn-group btn-group-sm" role="group">
                        <input type="radio" class="btn-check" name="taxMode" id="taxModeGST" autocomplete="off" checked onchange="setGlobalTax(false)">
                        <label class="btn btn-outline-secondary py-1 px-2" style="font-size: 0.75rem;" for="taxModeGST">GST</label>

                        <input type="radio" class="btn-check" name="taxMode" id="taxModeIGST" autocomplete="off" onchange="setGlobalTax(true)">
                        <label class="btn btn-outline-primary py-1 px-2" style="font-size: 0.75rem;" for="taxModeIGST">IGST</label>
                    </div>
                </div>

                <button class="btn btn-outline-secondary btn-sm ms-2" onclick="clearBill()" title="Clear and Start New (Alt+C)">
                    <i class="bi bi-arrow-counterclockwise"></i> Reset
                </button>
            </div>

            <!-- Items Table -->
            <div class="items-area">
                <div class="table-wrapper">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>S.No.</th>
                                <th>HSN</th>
                                <th>Product Name</th>
                                <th>Packing</th>
                                <th class="text-center" style="width: 80px;">Qty</th>
                                <th>MFG Date</th>
                                <th>Batch No.</th>
                                <th>Exp Date</th>
                                <th class="text-end">MRP</th>
                                <th class="text-end">Rate</th>
                                <th class="text-center">Tax Type</th>
                                <th class="text-end">IGST</th>
                                <th class="text-end">CGST</th>
                                <th class="text-end">SGST</th>
                                <th class="text-end">Tax Amt</th>
                                <th class="text-end">Amount</th>
                                <th class="text-center" style="width: 50px;"></th>
                            </tr>
                        </thead>
                        <tbody id="billItems">
                            <!-- Items populated here -->
                        </tbody>
                    </table>
                </div>
                <div id="emptyState" class="d-flex flex-column align-items-center justify-content-center h-100 text-muted p-5 opacity-50" style="display: none;">
                    <i class="bi bi-cart-x fs-1 mb-2"></i>
                    <p>No items added yet</p>
                </div>
            </div>

            <!-- Bottom Control Panel -->
            <div class="summary-panel">
                
                <!-- Customer Info -->
                <!-- Customer Info -->
                <div class="summary-col" style="flex: 1.3;">
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <i class="bi bi-person-circle text-primary"></i>
                        <h6 class="fw-bold m-0 text-dark" style="font-size: 0.9rem;">Customer Info</h6>
                    </div>
                    <div class="row g-1">
                        <div class="col-4">
                            <label class="form-label-sm">First Name</label>
                            <input type="text" class="form-control form-control-desktop" id="customerFirstName" placeholder="First Name">
                        </div>
                         <div class="col-4">
                            <label class="form-label-sm">Last Name</label>
                            <input type="text" class="form-control form-control-desktop" id="customerLastName" placeholder="Last Name">
                        </div>
                        <div class="col-4">
                            <label class="form-label-sm">Phone</label>
                            <input type="tel" class="form-control form-control-desktop" id="customerPhone" placeholder="Mobile No.">
                        </div>
                        <div class="col-12">
                            <input type="text" class="form-control form-control-desktop mt-1" id="customerAddress" placeholder="Address Line 1">
                        </div>
                         <div class="col-4">
                            <input type="text" class="form-control form-control-desktop mt-1" id="customerCity" placeholder="City">
                        </div>
                        <div class="col-4">
                            <input type="text" class="form-control form-control-desktop mt-1" id="customerDistrict" placeholder="District">
                        </div>
                        <div class="col-4">
                            <input type="text" class="form-control form-control-desktop mt-1" id="customerState" placeholder="State">
                        </div>
                         <div class="col-4">
                            <input type="text" class="form-control form-control-desktop mt-1" id="customerPincode" placeholder="Pincode">
                        </div>
                        <div class="col-4">
                             <input type="text" class="form-control form-control-desktop mt-1" id="customerSubDistrict" placeholder="Taluka">
                        </div>
                         <div class="col-4">
                            <input type="text" class="form-control form-control-desktop mt-1" id="customerNote" placeholder="Extra Note">
                        </div>
                    </div>
                </div>

                <!-- Payment Info -->
                <div class="summary-col border-start ps-3 border-end pe-3">
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <i class="bi bi-credit-card text-primary"></i>
                        <h6 class="fw-bold m-0 text-dark" style="font-size: 0.9rem;">Payment Details</h6>
                    </div>
                    <div class="row g-1">
                         <div class="col-6">
                            <label class="form-label-sm">Status</label>
                            <select class="form-select form-select-sm form-control-desktop" id="paymentStatus" onchange="togglePaymentFields()">
                                <option value="Paid">Paid (Full)</option>
                                <option value="Pending">Pending (Credit)</option>
                                <option value="Partially Paid">Partial</option>
                            </select>
                        </div>
                        <div class="col-6" id="paymentModeContainer">
                            <label class="form-label-sm">Mode</label>
                            <select class="form-select form-select-sm form-control-desktop" id="paymentMode">
                                <option value="Cash">Cash</option>
                                <option value="Online">Online / UPI</option>
                            </select>
                        </div>
                        <div class="col-6" id="paidAmountContainer" style="display: none;">
                            <label class="form-label-sm">Paid Amt</label>
                            <input type="number" class="form-control form-control-desktop" id="paidAmount" min="0" step="0.01">
                        </div>
                        <div class="col-6" id="paymentDateContainer">
                            <label class="form-label-sm">Date</label>
                            <input type="date" class="form-control form-control-desktop" id="paymentDate">
                        </div>
                        <div class="col-12">
                            <label class="form-label-sm">Discount <span class="text-muted fw-normal">(Alt+D)</span></label>
                             <div class="input-group input-group-sm" style="height: 28px;">
                                <span class="input-group-text py-0">₹</span>
                                <input type="number" class="form-control form-control-desktop" id="discount" value="0">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Totals & Actions -->
                <!-- Totals & Actions -->
                <div class="summary-col-actions">
                    <div class="total-row px-1">
                        <span>Subtotal:</span>
                        <span id="subtotal" class="fw-bold text-dark">₹0.00</span>
                    </div>
                    <div class="total-row px-1 text-muted mb-2">
                        <span>Tax (GST):</span>
                        <span id="totalTax">₹0.00</span>
                    </div>
                    
                    <div class="grand-total-box">
                        <div class="small opacity-75 text-uppercase" style="font-size: 0.65rem; letter-spacing: 1px;">Net Payable</div>
                        <div id="finalAmount" class="fs-4 fw-bold">₹0.00</div>
                    </div>

                    <div class="d-flex justify-content-between small text-danger fw-bold px-1 my-1" id="remainingContainer" style="display:none;">
                        <span>Balance:</span>
                        <span id="remainingAmount">₹0.00</span>
                    </div>

                    <div class="d-grid gap-2 mt-auto">
                        <button class="btn btn-primary shadow-sm fw-bold" onclick="generateBill()">
                            <i class="bi bi-printer-fill me-2"></i> Print Bill
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="app-branding">
           MediBill Pro v2.0
        </div>
    </div>

    <!-- Logic Script -->
    <script>
        // State
        let billItems = [];
        let selectedSearchIndex = -1;
        let currentSearchResults = [];
        const BILL_STATE_KEY = 'billing_app_current_state';

        // Clock
        function updateClock() {
            const now = new Date();
            document.getElementById('liveClock').innerText = now.toLocaleString('en-US', { 
                weekday: 'short', month: 'short', day: 'numeric', year: 'numeric',
                hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: true 
            });
        }
        setInterval(updateClock, 1000);
        updateClock();

        // Init
        document.addEventListener('DOMContentLoaded', function() {
            loadBillState();
            
            // Set default date
            const dateInput = document.getElementById('paymentDate');
            if(!dateInput.value) dateInput.valueAsDate = new Date();

            // Auto-save listeners
            const fieldsToWatch = [
                'customerFirstName', 'customerLastName', 'customerPhone', 
                'customerAddress', 'customerCity', 'customerDistrict', 
                'customerState', 'customerPincode', 'customerSubDistrict', 'customerNote',
                'paymentMode', 'paymentDate', 'paidAmount', 'discount'
            ];
            
            fieldsToWatch.forEach(id => {
                const el = document.getElementById(id);
                if(el) {
                    el.addEventListener('input', () => {
                        calculateTotal(); // Recalc on discount change
                        saveBillState();
                    });
                }
            });
        });

        // Search Logic
        let searchTimeout;
        const searchInput = document.getElementById('productSearch');
        const searchResults = document.querySelector('.search-results');

        searchInput.addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => searchProducts(e.target.value), 300);
        });

        // Keyboard Navigation for Search
        searchInput.addEventListener('keydown', function(e) {
            if (searchResults.style.display !== 'none') {
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedSearchIndex = Math.min(selectedSearchIndex + 1, currentSearchResults.length - 1);
                    updateSearchSelection();
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedSearchIndex = Math.max(selectedSearchIndex - 1, 0);
                    updateSearchSelection();
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (selectedSearchIndex >= 0 && currentSearchResults[selectedSearchIndex]) {
                        addProduct(currentSearchResults[selectedSearchIndex]);
                    }
                } else if (e.key === 'Escape') {
                    searchResults.style.display = 'none';
                }
            }
        });

        function searchProducts(query) {
            if (!query) {
                searchResults.style.display = 'none';
                return;
            }

            fetch(`/billing/search-products/?q=${encodeURIComponent(query)}`)
                .then(res => res.json())
                .then(data => {
                    const resultsHelper = document.querySelector('.search-results');
                    resultsHelper.innerHTML = '';
                    selectedSearchIndex = -1;
                    currentSearchResults = data.products || [];

                    if (currentSearchResults.length > 0) {
                        currentSearchResults.forEach((product, index) => {
                            const div = document.createElement('div');
                            div.className = 'search-result-item';
                            div.innerHTML = `
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex flex-column">
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="fw-bold text-dark">${product.name}</span>
                                            ${product.hsn_number ? `<span class="badge bg-light text-secondary border" style="font-size: 0.65rem;">HSN: ${product.hsn_number}</span>` : ''}
                                        </div>
                                        <small class="text-muted" style="font-size: 0.75rem;">
                                            Batch: ${product.batch_number || 'N/A'} • MFG: ${product.mfg_date || 'N/A'} • Exp: ${product.expiry_date || 'N/A'}
                                        </small>
                                    </div>
                                    <div class="text-end">
                                        <div class="fw-bold text-primary">₹${parseFloat(product.price)} / ${product.unit || 'Unit'}</div>
                                        <small class="text-muted d-block">Stock: ${parseFloat(product.stock)}</small>
                                    </div>
                                </div>
                            `;
                            div.onclick = () => addProduct(product);
                            div.onmouseenter = () => { selectedSearchIndex = index; updateSearchSelection(); };
                            resultsHelper.appendChild(div);
                        });
                        resultsHelper.style.display = 'block';
                        
                        // Auto-select first result if exact match or simple search
                        if(currentSearchResults.length > 0) {
                            selectedSearchIndex = 0;
                            updateSearchSelection();
                        }
                    } else {
                        resultsHelper.style.display = 'none';
                    }
                })
                .catch(err => console.error(err));
        }

        function updateSearchSelection() {
            const items = document.querySelectorAll('.search-result-item');
            if(items.length === 0) return;
            items.forEach((item, index) => {
                if (index === selectedSearchIndex) {
                    item.classList.add('active');
                    item.scrollIntoView({ block: 'nearest' });
                } else {
                    item.classList.remove('active');
                }
            });
        }

        // Bill Logic
        function addProduct(product) {
            try {
                // Prevent duplicate add from separate events if handled quickly
                if(document.activeElement === searchInput) {
                    // searchInput.focus(); // Keep focus
                }
                
                const existingItem = billItems.find(item => item.id === product.id);
                const gstRate = parseFloat(product.gst_rate) || 0;
                const price = parseFloat(product.price);
                
                if (existingItem) {
                    existingItem.quantity += 1;
                    updateItemCalculations(existingItem);
                } else {
                    const newItem = {
                        id: product.id,
                        product_id: product.id,
                        name: product.name,
                        hsn_number: product.hsn_number || '',
                        unit: product.unit || '',
                        price: price, // Rate
                        mrp: parseFloat(product.mrp) || 0,
                        batch_number: product.batch_number || '',
                        expiry_date: product.expiry_date,
                        mfg_date: product.mfg_date,
                        quantity: 1,
                        gstRate: gstRate, // Total GST Rate
                        isIgst: document.getElementById('taxModeIGST').checked || false, // Respect Global Radio
                        stock: product.stock,
                        igst: 0,
                        cgst: 0,
                        sgst: 0,
                        taxAmount: 0,
                        total: 0
                    };
                    updateItemCalculations(newItem);
                    billItems.push(newItem);
                }

                updateBillTable();
                calculateTotal();
                saveBillState();

                // Reset Search
                searchInput.value = '';
                searchResults.style.display = 'none';
                searchInput.focus();
            } catch (e) {
                console.error("Error adding product:", e);
                alert("Error adding product: " + e.message);
            }
        }

        function setGlobalTax(isIgst) {
            billItems.forEach(item => {
                item.isIgst = isIgst;
                updateItemCalculations(item);
            });
            updateBillTable();
            calculateTotal();
            saveBillState();
        }

        function updateDate(index, field, value) {
            billItems[index][field] = value;
            saveBillState();
        }
        
        function updateItemCalculations(item) {
            const baseTotal = item.quantity * item.price;
            
            if (item.isIgst) {
                item.igst = (baseTotal * item.gstRate) / 100;
                item.cgst = 0;
                item.sgst = 0;
            } else {
                item.igst = 0;
                item.cgst = (baseTotal * (item.gstRate / 2)) / 100;
                item.sgst = (baseTotal * (item.gstRate / 2)) / 100;
            }
            
            item.taxAmount = item.igst + item.cgst + item.sgst;
            item.total = baseTotal + item.taxAmount;
        }

        function updateQuantity(index, newQty) {
            const item = billItems[index];
            const qty = parseFloat(newQty);
            if (qty > 0) {
                item.quantity = qty;
                updateItemCalculations(item);
                updateBillTable();
                calculateTotal();
                saveBillState();
            }
        }

        function removeItem(index) {
            billItems.splice(index, 1);
            updateBillTable();
            calculateTotal();
            saveBillState();
        }

        function updateBillTable() {
            const tbody = document.getElementById('billItems');
            const emptyState = document.getElementById('emptyState');
            tbody.innerHTML = '';

            if (billItems.length === 0) {
                if(emptyState) {
                    emptyState.classList.remove('d-none');
                    emptyState.classList.add('d-flex');
                }
                return;
            }
            if(emptyState) {
                emptyState.classList.remove('d-flex');
                emptyState.classList.add('d-none');
            }

            billItems.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.hsn_number}</td>
                    <td><div class="fw-500 text-dark">${item.name}</div></td>
                    <td>${item.unit}</td>
                    <td class="text-center">
                        <input type="number" class="form-control form-control-sm text-center mx-auto" 
                               style="width: 70px;"
                               value="${parseFloat(item.quantity)}" min="0.001" step="any"
                               onchange="updateQuantity(${index}, this.value)">
                    </td>
                    <td>
                        <input type="month" class="form-control form-control-sm" style="width: 130px;"
                               value="${(item.mfg_date || '').slice(0, 7)}"
                               onchange="updateDate(${index}, 'mfg_date', this.value)">
                    </td>
                    <td>${item.batch_number}</td>
                    <td>
                        <input type="month" class="form-control form-control-sm" style="width: 130px;"
                               value="${(item.expiry_date || '').slice(0, 7)}"
                               onchange="updateDate(${index}, 'expiry_date', this.value)">
                    </td>
                    <td class="text-end small">₹${item.mrp.toFixed(2)}</td>
                    <td class="text-end small">₹${item.price.toFixed(2)}</td>
                    <td class="text-center">
                        <span class="badge ${item.isIgst ? 'bg-primary' : 'bg-secondary'} bg-opacity-10 text-${item.isIgst ? 'primary' : 'secondary'} border border-${item.isIgst ? 'primary' : 'secondary'}" style="font-size: 0.7rem;">
                            ${item.isIgst ? 'IGST' : 'GST'}
                        </span>
                    </td>
                    <td class="text-end small">${item.isIgst ? item.gstRate + '%' : '-'}</td>
                    <td class="text-end small">${!item.isIgst ? (item.gstRate/2) + '%' : '-'}</td>
                    <td class="text-end small">${!item.isIgst ? (item.gstRate/2) + '%' : '-'}</td>
                    <td class="text-end small">₹${item.taxAmount.toFixed(2)}</td>
                    <td class="text-end fw-bold text-dark">₹${item.total.toFixed(2)}</td>
                    <td class="text-center">
                        <button class="btn btn-link text-danger p-0 basic-hover" onclick="removeItem(${index})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            // Re-calc totals logic (already exists but ensures UI sync)
            calculateTotal();
        }

        function calculateTotal() {
            let subtotal = 0;
            let totalTax = 0;
            
            billItems.forEach(item => {
                subtotal += (item.quantity * item.price);
                totalTax += item.taxAmount;
            });
            
            const discount = parseFloat(document.getElementById('discount').value) || 0;
            const grandTotal = subtotal + totalTax - discount;
            
            document.getElementById('subtotal').innerText = '₹' + subtotal.toFixed(2);
            document.getElementById('totalTax').innerText = '₹' + totalTax.toFixed(2);
            document.getElementById('finalAmount').innerText = '₹' + grandTotal.toFixed(2);
            
            // Update remaining/paid visual logic if needed
            const status = document.getElementById('paymentStatus').value;
             if (status === 'Partially Paid') {
                const paid = parseFloat(document.getElementById('paidAmount').value) || 0;
                document.getElementById('remainingAmount').innerText = '₹' + Math.max(0, grandTotal - paid).toFixed(2);
             }
        }
        
        function generateBill() {
             const firstName = document.getElementById('customerFirstName').value.trim();
             const lastName = document.getElementById('customerLastName').value.trim();
             const fullName = (firstName + ' ' + lastName).trim();
             
             if(!fullName) { alert('Please enter customer name'); return; }
             if(billItems.length === 0) { alert('Add products first'); return; }
             
             // 1. Confirm with User
             if(!confirm("Are you sure you want to Save & Print this bill?")) return;
             
             const data = {
                 customer: {
                     name: fullName,
                     phone: document.getElementById('customerPhone').value,
                     address: document.getElementById('customerAddress').value,
                     city: document.getElementById('customerCity').value,
                     district: document.getElementById('customerDistrict').value,
                     state: document.getElementById('customerState').value,
                     pincode: document.getElementById('customerPincode').value,
                     sub_district: document.getElementById('customerSubDistrict').value,
                     extra_note: document.getElementById('customerNote').value
                 },
                 items: billItems.map(item => ({
                     product_id: item.id,
                     quantity: item.quantity,
                     gst_rate: item.gstRate,
                     is_igst: item.isIgst,
                     hsn_number: item.hsn_number,
                     mfg_date: item.mfg_date,
                     expiry_date: item.expiry_date,
                     unit: item.unit
                 })),
                 discount: document.getElementById('discount').value,
                 payment_status: document.getElementById('paymentStatus').value,
                 payment_mode: document.getElementById('paymentMode').value,
                 payment_date: document.getElementById('paymentDate').value,
                 paid_amount: document.getElementById('paidAmount').value
             };
             
             fetch('/billing/', {
                 method: 'POST',
                 headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                 body: JSON.stringify(data)
             })
             .then(r => r.json())
             .then(data => {
                 if(data.success) {
                     // 2. Success Alert/Toast
                     alert('Bill Saved Successfully! Printing...');
                     
                     // 3. Clear & Print
                     // We print BEFORE clearing state visual, OR we reload.
                     // A simple window.print() prints the CURRENT PAGE. 
                     // Users usually want a clean invoice. 
                     // Since we don't have a view_invoice URL, we will print current page.
                     // The user asked to "Ask for save bill then ok then print".
                     
                     window.print();
                     
                     // After print dialog closes (or immediately in some browsers), reload to clear.
                     // We use a small timeout to allow the print dialog to register.
                     setTimeout(() => {
                         clearBill();
                         window.location.reload(); 
                     }, 1000);
                     
                 } else {
                     alert('Error: ' + data.error);
                 }
             })
             .catch(e => alert('Network error'));
        }
        
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                     if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function togglePaymentFields() {
            const status = document.getElementById('paymentStatus').value;
            const modeContainer = document.getElementById('paymentModeContainer');
            const paidContainer = document.getElementById('paidAmountContainer');
            const dateContainer = document.getElementById('paymentDateContainer');
            
            if (status === 'Paid') {
                modeContainer.style.display = 'block';
                paidContainer.style.display = 'none';
                dateContainer.style.display = 'block';
            } else if (status === 'Partially Paid') {
                modeContainer.style.display = 'block';
                paidContainer.style.display = 'block';
                dateContainer.style.display = 'block';
            } else { // Pending
                modeContainer.style.display = 'none';
                paidContainer.style.display = 'none';
                dateContainer.style.display = 'none';
            }
             calculateTotal(); // Update balance if partially paid
        }

        function clearBill() {
            billItems = [];
            localStorage.removeItem(BILL_STATE_KEY);
            updateBillTable();
            document.getElementById('customerFirstName').value = '';
            document.getElementById('customerLastName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerAddress').value = '';
            document.getElementById('customerCity').value = '';
            document.getElementById('customerDistrict').value = '';
            document.getElementById('customerState').value = '';
            document.getElementById('customerPincode').value = '';
            document.getElementById('customerSubDistrict').value = '';
            document.getElementById('customerNote').value = '';
        }

        function saveBillState() {
            const state = {
                items: billItems,
                customer: {
                    firstName: document.getElementById('customerFirstName').value,
                    lastName: document.getElementById('customerLastName').value,
                    phone: document.getElementById('customerPhone').value,
                    address: document.getElementById('customerAddress').value,
                    city: document.getElementById('customerCity').value,
                    district: document.getElementById('customerDistrict').value,
                    state: document.getElementById('customerState').value,
                    pincode: document.getElementById('customerPincode').value,
                    sub_district: document.getElementById('customerSubDistrict').value,
                    extra_note: document.getElementById('customerNote').value
                },
                payment: {
                    status: document.getElementById('paymentStatus').value,
                    mode: document.getElementById('paymentMode').value,
                    date: document.getElementById('paymentDate').value,
                    paidAmount: document.getElementById('paidAmount').value
                },
                discount: document.getElementById('discount').value
            };
            localStorage.setItem(BILL_STATE_KEY, JSON.stringify(state));
        }

        function loadBillState() {
            const savedState = localStorage.getItem(BILL_STATE_KEY);
            if (!savedState) return;
            try {
                const state = JSON.parse(savedState);
                if (state.items) {
                    // Migrate/Sanitize old items
                    billItems = state.items.map(item => ({
                        ...item,
                        hsn_number: item.hsn_number || '',
                        unit: item.unit || '',
                        mfg_date: item.mfg_date || '',
                        expiry_date: item.expiry_date || '',
                        isIgst: item.isIgst === undefined ? false : item.isIgst,
                        igst: item.igst || 0,
                        cgst: item.cgst || 0,
                        sgst: item.sgst || 0,
                        taxAmount: item.taxAmount || 0
                    }));
                }
                if (state.customer) {
                    // Handle transition from name to firstName/lastName if needed
                    if(state.customer.name && !state.customer.firstName) {
                         const parts = state.customer.name.split(' ');
                         document.getElementById('customerFirstName').value = parts[0] || '';
                         document.getElementById('customerLastName').value = parts.slice(1).join(' ') || '';
                    } else {
                        document.getElementById('customerFirstName').value = state.customer.firstName || '';
                        document.getElementById('customerLastName').value = state.customer.lastName || '';
                    }
                    
                    document.getElementById('customerPhone').value = state.customer.phone || '';
                    document.getElementById('customerAddress').value = state.customer.address || '';
                    
                    document.getElementById('customerCity').value = state.customer.city || '';
                    document.getElementById('customerDistrict').value = state.customer.district || '';
                    document.getElementById('customerState').value = state.customer.state || '';
                    document.getElementById('customerPincode').value = state.customer.pincode || '';
                    document.getElementById('customerSubDistrict').value = state.customer.sub_district || '';
                    document.getElementById('customerNote').value = state.customer.extra_note || '';
                }
                if (state.payment) {
                    document.getElementById('paymentStatus').value = state.payment.status || 'Paid';
                    document.getElementById('paymentMode').value = state.payment.mode || 'Cash';
                    if (state.payment.date) document.getElementById('paymentDate').value = state.payment.date;
                    if (state.payment.paidAmount) document.getElementById('paidAmount').value = state.payment.paidAmount;
                }
                if (state.discount) document.getElementById('discount').value = state.discount;
                
                togglePaymentFields();
                
                // Sync Global Toggle if items exist
                if(billItems.length > 0) {
                    const isIgst = billItems[0].isIgst;
                    if(isIgst) document.getElementById('taxModeIGST').checked = true;
                    else document.getElementById('taxModeGST').checked = true;
                }

                updateBillTable();
                calculateTotal();
            } catch (e) { console.error('Error loading state', e); }
        }
    </script>
</body>
</html>