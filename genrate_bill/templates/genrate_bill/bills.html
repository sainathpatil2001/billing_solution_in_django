{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Bills - MediBill Pro</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <style>
        :root {
            --sidebar-width: 260px;
            --primary-bg: #f3f4f6;
            --sidebar-bg: #1e293b;
            --sidebar-text: #e2e8f0;
            --accent-color: #3b82f6;
            --card-bg: #ffffff;
            --font-family: 'Inter', sans-serif;
            --border-color: #e5e7eb;
            --primary-color: #4361ee;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--primary-bg);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            overflow: hidden; /* Prevent body scroll in desktop app feel */
        }

        /* Sidebar Styles (Shared) */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            display: flex;
            flex-direction: column;
            height: 100vh;
            flex-shrink: 0;
        }

        .brand-section {
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .brand-logo {
            width: 32px;
            height: 32px;
            background: var(--accent-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        .brand-text { font-weight: 600; font-size: 1.1rem; letter-spacing: 0.5px; }

        .nav-menu {
            flex: 1;
            padding: 1.5rem 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            color: #94a3b8;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.2s;
            font-weight: 500;
        }

        .nav-item:hover, .nav-item.active { background-color: rgba(255,255,255,0.1); color: white; }
        .nav-item.active { background-color: var(--accent-color); }
        .nav-item i { font-size: 1.2rem; }

        .user-section {
            padding: 1rem;
            border-top: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.2);
        }

        .business-badge-sidebar {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            border-radius: 8px;
        }
        
        .business-logo-mini {
            width: 36px; height: 36px; border-radius: 50%; background: white; 
            object-fit: contain; border: 2px solid rgba(255,255,255,0.2);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }
        
        .content-scrollable {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        /* Glass Card Utility */
        .glass-card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        /* Filter Styles */
        .form-control, .form-select {
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            padding: 0.6rem 0.8rem;
            font-size: 0.9rem;
        }
        .form-control:focus, .form-select:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }
        
        .search-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 0.3rem;
            display: block;
        }

        /* Table Area */
        .table-container {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .table thead th {
            background: #f8fafc;
            color: #64748b;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .table tbody td {
            vertical-align: middle;
            padding: 1rem;
            border-bottom: 1px solid #f1f5f9;
            color: #334155;
            font-size: 0.95rem;
        }

        .status-badge {
            padding: 0.35rem 0.75rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }
        .status-paid { background-color: #dcfce7; color: #166534; }
        .status-partial { background-color: #fef9c3; color: #854d0e; }
        .status-pending { background-color: #fee2e2; color: #991b1b; }

        .btn-action {
            width: 32px; height: 32px;
            border-radius: 6px;
            display: inline-flex; align-items: center; justify-content: center;
            border: none;
            margin: 0 2px;
            transition: all 0.2s;
        }
        .btn-view { background: #e0f2fe; color: #0284c7; }
        .btn-view:hover { background: #0284c7; color: white; }
        .btn-print { background: #dcfce7; color: #16a34a; }
        .btn-print:hover { background: #16a34a; color: white; }
        .btn-pay { background: #ffedd5; color: #ea580c; }
        .btn-pay:hover { background: #ea580c; color: white; }

        /* Loader */
        .spinner-loader {
            width: 1rem; height: 1rem;
            border: 2px solid rgba(59, 130, 246, 0.2);
            border-right-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
            display: none;
        }
        @keyframes spin { 100% { transform: translateY(-50%) rotate(360deg); } }
        .loading .spinner-loader { display: block; }
        .loading .input-icon { display: none; }
        .input-icon { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #94a3b8; }

        /* App Branding */
        .app-branding {
            position: absolute; bottom: 5px; right: 15px; font-size: 0.7rem; 
            color: #cbd5e1; pointer-events: none; z-index: 100;
        }

        /* Responsive */
        @media screen and (max-width: 992px) {
            .sidebar { transform: translateX(-100%); position: absolute; z-index: 1000; }
            .sidebar.show { transform: translateX(0); }
            /* Add toggle trigger if needed, but assuming desktop main usage */
        }

        /* PRINT STYLES - Half Page Horizontal (A5 Landscape on A4) */
        @media print {
            @page { 
                size: A4 portrait; 
                margin: 3mm; 
            }
            
            body { 
                background: white;
                -webkit-print-color-adjust: exact;
            }

            /* Hide everything standard */
            .sidebar, .main-content, .no-print, .modal-header, .modal-footer, .modal-backdrop { 
                display: none !important; 
                visibility: hidden !important;
            }

            /* Make modal visible and reshape it */
            #billModal {
                position: static !important;
                display: block !important;
                visibility: visible !important;
                width: 100% !important;
                height: auto !important;
                background: white !important;
                overflow: visible !important;
                padding: 0 !important;
                margin: 0 !important;
            }

            .modal-dialog {
                max-width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            .modal-content {
                border: none !important;
                box-shadow: none !important;
                width: 100% !important;
            }

            .modal-body {
                padding: 0 !important;
                visibility: visible !important;
            }

            /* The specific bill container adjustments for Half Page */
            #billDetails {
                width: 100%;
                /* A4 Height is ~297mm. Half is ~148mm. We set a max to ensure it fits.*/
                max-height: 140mm; 
                position: relative;
                overflow: hidden;
                /* border: 1px solid #ddd; */ /* Removed extra border */
                padding: 0 !important;
                box-sizing: border-box;
            }
            
            /* Scaling for compact fit */
            /* Font overrides removed to allow invoice specific styles (10px/11px) to take precedence for compactness */
            
            /* Compact Spacing */
            #billDetails .mb-3, #billDetails .mb-4 { margin-bottom: 0.5rem !important; }
            #billDetails .p-4 { padding: 0 !important; }
            #billDetails .row { margin-left: -5px; margin-right: -5px; }
            #billDetails .col-*, #billDetails [class^="col-"] { padding-left: 5px; padding-right: 5px; }
            
            /* Signature & Footer in Fixed Position relative to half-page container */
            #billDetails .border-top { border-top: 1px solid #aaa !important; margin-top: 1rem !important; padding-top: 0.5rem !important; }
            
            #watermark { display: flex !important; opacity: 0.03 !important; }
        }
    </style>
</head>
<body>

    <!-- Desktop Sidebar -->
    <div class="sidebar no-print">
        <div class="brand-section">
            <div class="brand-logo"><i class="bi bi-wallet2"></i></div>
            <div class="brand-text">MediBill Pro</div>
        </div>
        <div class="nav-menu">
            <a href="/billing/" class="nav-item">
                <i class="bi bi-receipt-cutoff"></i><span>New Invoice</span>
            </a>
            <a href="/billing/bills/" class="nav-item active">
                <i class="bi bi-clock-history"></i><span>History & Search</span>
            </a>
            <a href="/inventory/inventory_management/" class="nav-item">
                <i class="bi bi-box-seam"></i><span>Inventory</span>
            </a>
            <a href="/billing/backup/" class="nav-item">
                <i class="bi bi-database-check"></i><span>Backup & Restore</span>
            </a>
            <a href="/billing/business-settings/" class="nav-item">
                <i class="bi bi-gear"></i><span>Settings</span>
            </a>
        </div>
        <div class="user-section">
            <div class="business-badge-sidebar">
                {% if business_info.logo %}
                <img src="{{ business_info.logo.url }}" alt="Logo" class="business-logo-mini">
                {% else %}
                <div class="business-logo-mini d-flex align-items-center justify-content-center text-primary fw-bold">
                    {{ business_info.company_name|slice:":1" }}
                </div>
                {% endif %}
                <div class="d-flex flex-column text-truncate">
                    <span class="small fw-bold text-white text-truncate">{{ business_info.company_name|default:"My Business" }}</span>
                    <span class="small text-muted" style="font-size: 0.7rem;">Dashboard</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
        <div class="content-scrollable no-print">
            <div class="d-flex align-items-center justify-content-between mb-4">
                <h4 class="fw-bold m-0 text-dark">Transaction History</h4>
                <div class="text-end">
                    <span class="text-muted small">Manage and track all your invoices</span>
                </div>
            </div>

            <!-- Filter Section -->
            <div class="glass-card">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <h6 class="fw-bold text-primary m-0"><i class="bi bi-sliders me-2"></i>Filter Records</h6>
                    <button onclick="clearSearch()" class="btn btn-sm btn-light border text-muted">
                        <i class="bi bi-arrow-counterclockwise me-1"></i>Reset
                    </button>
                </div>
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="position-relative">
                            <span class="search-label">Bill Number</span>
                            <div class="position-relative">
                                <input type="text" id="billNumber" class="form-control" placeholder="Type ID...">
                                <i class="bi bi-hash input-icon"></i>
                                <div class="spinner-loader"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="position-relative">
                            <span class="search-label">Customer Name</span>
                            <div class="position-relative">
                                <input type="text" id="customerName" class="form-control" placeholder="Search name...">
                                <i class="bi bi-person input-icon"></i>
                                <div class="spinner-loader"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="position-relative">
                            <span class="search-label">Payment Status</span>
                            <select id="paymentStatus" class="form-select">
                                <option value="">All Statuses</option>
                                <option value="Paid">Paid</option>
                                <option value="Partially Paid">Partially Paid</option>
                                <option value="Pending">Pending</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="position-relative">
                            <span class="search-label">Date</span>
                            <input type="date" id="billDate" class="form-control">
                             <div class="spinner-loader"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="table-container">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Bill #</th>
                                <th>Date</th>
                                <th>Customer</th>
                                <th class="text-end">Total</th>
                                <th class="text-end">Paid</th>
                                <th class="text-center">Status</th>
                                <th class="text-center" style="width: 140px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="billsTableBody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="app-branding">
           MediBill Pro v2.0
        </div>
    </div>

    <!-- Modals -->
    <!-- Bill Details Modal (Printing) -->
    <div class="modal fade" id="billModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header no-print border-0 pb-0">
                    <h5 class="modal-title fw-bold">Invoice Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="billDetails"></div>
                <div class="modal-footer no-print border-0 pt-0">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="printBill()">
                        <i class="bi bi-printer-fill me-2"></i>Print
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Update Modal -->
    <div class="modal fade" id="updatePaymentModal" tabindex="-1">
         <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header border-0 bg-light">
                    <h5 class="modal-title fw-bold text-primary">Update Payment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="updatePaymentForm">
                        <input type="hidden" id="updateBillId">
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">New Status</label>
                            <select class="form-select" id="updateStatus" onchange="handleUpdateStatusChange()">
                                <option value="Pending">Pending</option>
                                <option value="Paid">Paid</option>
                                <option value="Partially Paid">Partially Paid</option>
                            </select>
                        </div>

                        <div id="updatePaymentDetails" style="display: none;" class="bg-light p-3 rounded mb-3 border">
                            <div class="mb-3" id="updatePaidAmountContainer" style="display: none;">
                                <label class="form-label small text-muted text-uppercase fw-bold">Amount to Pay</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-white border-end-0 fw-bold">₹</span>
                                    <input type="number" class="form-control border-start-0 ps-0" id="updatePaidAmount" min="0" step="0.01">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label small text-muted text-uppercase fw-bold">Mode</label>
                                    <select class="form-select" id="updatePaymentMode">
                                        <option value="Cash">Cash</option>
                                        <option value="Online">Online</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label small text-muted text-uppercase fw-bold">Date</label>
                                    <input type="date" class="form-control" id="updatePaymentDate">
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Security Password</label>
                            <input type="password" class="form-control" id="securityPassword" placeholder="Admin Password" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitPaymentUpdate()">Update</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1060;">
        <div id="liveToast" class="toast hide" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="bi bi-info-circle-fill me-2" id="toastIcon"></i>
                <strong class="me-auto" id="toastTitle">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toastMessage">
                Notification message
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let searchTimeout = null;
        const SEARCH_DELAY = 300; 

        document.addEventListener('DOMContentLoaded', function() {
            searchBills();
            
            // Listeners
            document.getElementById('billNumber').addEventListener('input', () => handleSearchInput('billNumber'));
            document.getElementById('customerName').addEventListener('input', () => handleSearchInput('customerName'));
            document.getElementById('billDate').addEventListener('change', () => handleSearchInput('billDate'));
            // Payment status immediate
            document.getElementById('paymentStatus').addEventListener('change', () => searchBills());
            
            // Highlight bill if query param exists
            const urlParams = new URLSearchParams(window.location.search);
            const highlightId = urlParams.get('highlight');
            if(highlightId) {
                document.getElementById('billNumber').value = highlightId;
                searchBills();
                // Optionally open details automatically:
                // viewBill(highlightId);
            }
        });

        function handleSearchInput(inputId) {
            const el = document.getElementById(inputId);
            const loader = el.parentElement.querySelector('.spinner-loader'); // Need to find logic to show spinner
            // The spinner is inside .position-relative next to input. 
            // My markup: pos-rel > input + icon + spinner.
            // .loading class on parent is best.
            const container = el.parentElement;
            container.classList.add('loading');

            if (searchTimeout) clearTimeout(searchTimeout);

            searchTimeout = setTimeout(() => {
                searchBills()
                    .finally(() => {
                        container.classList.remove('loading');
                    });
            }, SEARCH_DELAY);
        }

        async function searchBills() {
            const billNumber = document.getElementById('billNumber').value.trim();
            const customerName = document.getElementById('customerName').value.trim();
            const billDate = document.getElementById('billDate').value;
            const paymentStatus = document.getElementById('paymentStatus').value;
            const tbody = document.getElementById('billsTableBody');

            // Initial load state if empty
            if(!tbody.innerHTML.trim()) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-5 text-muted">Loading...</td></tr>';
            }

            try {
                const params = new URLSearchParams();
                if (billNumber) params.append('bill_number', billNumber);
                if (customerName) params.append('customer_name', customerName);
                if (billDate) params.append('date', billDate);
                if (paymentStatus) params.append('payment_status', paymentStatus);

                const response = await fetch(`/billing/search-bills/?${params.toString()}`);
                const data = await response.json();

                if (data.success) {
                    displayBills(data.bills);
                } else {
                    console.error(data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger py-4">Error loading data</td></tr>`;
            }
        }

        function displayBills(bills) {
            const tbody = document.getElementById('billsTableBody');
            tbody.innerHTML = '';

            if (!bills || bills.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-5">
                            <i class="bi bi-search display-6 text-muted opacity-25 mb-3 d-block"></i>
                            <p class="text-muted mb-0">No transactions found</p>
                        </td>
                    </tr>`;
                return;
            }

            bills.forEach(bill => {
                let statusClass = 'status-pending';
                let icon = 'bi-exclamation-circle';
                
                if (bill.payment_status === 'Paid') {
                    statusClass = 'status-paid';
                    icon = 'bi-check-circle';
                } else if (bill.payment_status === 'Partially Paid') {
                    statusClass = 'status-partial';
                    icon = 'bi-pie-chart';
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><span class="fw-bold text-primary">#${bill.bill_number}</span></td>
                    <td>${bill.date}</td>
                    <td>
                        <div class="fw-bold text-dark">${bill.customer_name || 'Walking Customer'}</div>
                        ${bill.customer_phone ? `<small class="text-muted d-block" style="font-size: 0.75rem;"><i class="bi bi-telephone me-1"></i>${bill.customer_phone}</small>` : ''}
                        ${bill.customer_address ? `<small class="text-muted d-block text-truncate" style="max-width: 180px; font-size: 0.75rem;"><i class="bi bi-geo-alt me-1"></i>${bill.customer_address}</small>` : ''}
                    </td>
                    <td class="text-end fw-bold">₹${parseFloat(bill.final_amount || 0).toFixed(2)}</td>
                    <td class="text-end text-success">
                         ₹${parseFloat(bill.paid_amount || 0).toFixed(2)}
                    </td>
                    <td class="text-center">
                        <span class="status-badge ${statusClass}">
                            <i class="bi ${icon}"></i> ${bill.payment_status || 'Pending'}
                        </span>
                    </td>
                    <td class="text-center">
                        <div class="d-flex justify-content-center gap-2">
                            <button onclick="viewBill('${bill.bill_number}')" class="btn-action btn-view" title="View Details">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button onclick="printBillDetails('${bill.bill_number}')" class="btn-action btn-print" title="Print Invoice">
                                <i class="bi bi-printer"></i>
                            </button>
                            <button onclick="updatePaymentStatus('${bill.bill_number}', '${bill.payment_status}', ${bill.paid_amount || 0})" class="btn-action btn-pay" title="Update Payment">
                                <i class="bi bi-credit-card"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function clearSearch() {
            document.getElementById('billNumber').value = '';
            document.getElementById('customerName').value = '';
            document.getElementById('billDate').value = '';
            document.getElementById('paymentStatus').value = '';
            searchBills();
        }

        // --- Details & Printing ---
        function viewBill(billId) {
            return fetch(`/billing/bill-details/${billId}/`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        displayBillDetails(data.bill);
                        new bootstrap.Modal(document.getElementById('billModal')).show();
                    } else showToast('Error: ' + data.error, 'error');
                });
        }

        function printBillDetails(billId) {
            viewBill(billId).then(() => {
                setTimeout(() => window.print(), 500);
            });
        }

        function printBill() { window.print(); }

        // --- Amount In Words Logic (Indian Numbering) ---
        function numberToWords(n) {
            const units = ['','One','Two','Three','Four','Five','Six','Seven','Eight','Nine','Ten','Eleven','Twelve','Thirteen','Fourteen','Fifteen','Sixteen','Seventeen','Eighteen','Nineteen'];
            const tens = ['','','Twenty','Thirty','Forty','Fifty','Sixty','Seventy','Eighty','Ninety'];

            if (n === 0) return ''; // Handle zero in recursion naturally
            if (n < 20) return units[n];
            if (n < 100) return tens[Math.floor(n/10)] + (n%10? ' ' + units[n%10] : '');
            if (n < 1000) return units[Math.floor(n/100)] + ' Hundred' + (n%100? ' and ' + numberToWords(n%100) : '');
            if (n < 100000) return numberToWords(Math.floor(n/1000)) + ' Thousand' + (n%1000? ' ' + numberToWords(n%1000) : '');
            if (n < 10000000) return numberToWords(Math.floor(n/100000)) + ' Lakh' + (n%100000? ' ' + numberToWords(n%100000) : '');
            return numberToWords(Math.floor(n/10000000)) + ' Crore' + (n%10000000? ' ' + numberToWords(n%10000000) : '');
        }

        function getAmountInWords(amount) {
            if(!amount || parseFloat(amount) === 0) return "Zero Rupees Only";
            
            let parts = parseFloat(amount).toFixed(2).split('.');
            let whole = parseInt(parts[0]);
            let decimal = parseInt(parts[1]);
            
            let str = numberToWords(whole) + " Rupees";
            if(decimal > 0) {
                str += " and " + numberToWords(decimal) + " Paise";
            }
            return str + " Only";
        }

        // --- Render Bill Details (Reused Logic) ---
        function formatTerms(text) {
            // Default terms if empty
            if (!text) {
                return '<li>Goods once sold will not be taken back or exchanged.</li><li>All disputes are subject to jurisdiction only.</li>';
            }
            
            // Split by newline OR by comma followed by a number (e.g. ", 2.") to handle single-line inputs
            // Regex: /[\r\n]+|,(?=\s*\d+\.)/
            return String(text).split(/[\r\n]+|,(?=\s*\d+\.)/).filter(t => t.trim()).map(t => {
                // Remove existing numbering like "1.", "2." from the start of the string to avoid double numbering with <ol> or ul decimal
                const cleanText = t.trim().replace(/^\s*\d+[\.\)]\s*/, '');
                return `<li>${cleanText}</li>`;
            }).join('');
        }

        // --- Render Bill Details (Replaced for GST Layout) ---
function displayBillDetails(bill) {
    const business = bill.business_info || {};

    // RESET Container Constraints to prevent clipping ("Not Covered")
    // Container constraints are NOW preserved for Half-Page print (max-height: 140mm defined in CSS)
    /* 
    const container = document.getElementById('billDetails');
    if(container) {
        container.style.maxHeight = 'none';
        container.style.overflow = 'visible';
        container.style.height = 'auto';
    }
    */

    // GST Invoice Layout
    let html = `
                <style>
                    /* Invoice Reset & Base */
                    .invoice-box * { box-sizing: border-box; }
                    .invoice-box {
                        font-family: 'Arial', sans-serif;
                        font-size: 11px;
                        color: black;
                        line-height: 1.3;
                        border: 2px solid black; /* Stronger outer border */
                        width: 100%;
                        margin: 0 auto;
                        background: white;
                    }
                    
                    /* Utility */
                    .w-100 { width: 100%; }
                    .fw-bold { font-weight: bold; }
                    .text-uppercase { text-transform: uppercase; }
                    .text-end { text-align: right; }
                    .text-center { text-align: center; }
                    .d-flex { display: flex; }
                    .align-top { align-items: flex-start; }
                    .align-center { align-items: center; }
                    .border-bottom { border-bottom: 1px solid black; }
                    .border-right { border-right: 1px solid black; }
                    .border-top { border-top: 1px solid black; }
                    .p-1 { padding: 4px; }
                    .p-2 { padding: 8px; }
                    .m-0 { margin: 0; }
                    .mb-1 { margin-bottom: 4px; }

                    /* Header Grid */
                    .header-section { display: flex; border-bottom: 1px solid black; align-items: stretch; }
                    
                    /* Seller Column (Left) */
                    .seller-col { 
                        width: 40%; 
                        border-right: 1px solid black; 
                        padding: 8px; 
                        display: flex; 
                        flex-direction: column; 
                    }
                    
                    /* Buyer Column (Right - Wrapper) */
                    .buyer-col { 
                        width: 60%; 
                        display: flex; 
                    }
                    
                    /* Receiver Details Sub-Column (Middle) */
                    .receiver-details-col {
                        flex: 1;
                        padding: 8px;
                        border-right: 1px solid black;
                        display: flex;
                        flex-direction: column;
                        justify-content: space-between; /* Push invoice details to bottom if space allows, or just stack */
                    }

                    /* Barcode Sub-Column (Right Edge) */
                    .barcode-col {
                        width: 140px; /* Fixed width for barcode box */
                        padding: 5px;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                    }
                    
                    .company-name { font-size: 18px; font-weight: bold; margin-bottom: 4px; }
                    .invoice-title { font-size: 16px; font-weight: bold; text-decoration: underline; margin-bottom: 5px; }

                    /* Table */
                    .items-table { width: 100%; border-collapse: collapse; font-size: 10px; border-bottom: 1px solid black; }
                    .items-table th { border-bottom: 1px solid black; border-right: 1px solid black; background-color: #f8f9fa; font-weight: bold; padding: 4px 2px; text-align: center; }
                    .items-table td { border-bottom: 1px solid black; border-right: 1px solid black; padding: 4px 2px; vertical-align: top; }
                    .items-table td:last-child, .items-table th:last-child { border-right: none; }
                    .items-table tr:last-child td { border-bottom: none; } /* Footer border handles closure */

                    /* Columns width tweaks */
                    .col-sn { width: 25px; text-align: center; }
                    .col-hsn { width: 40px; }
                    .col-prod { } 
                    .col-pack { width: 45px; }
                    .col-mrp { width: 50px; }
                    .col-batch { width: 60px; }
                    .col-exp { width: 40px; }
                    .col-qty { width: 35px; }
                    .col-rate { width: 50px; }
                    .col-amt { width: 60px; }
                    .col-mfg { width: 50px; }

                    /* Footer */
                    .footer-amount-words { border-bottom: 1px solid black; padding: 5px; font-weight: bold; font-style: italic; }
                    .footer-main { display: flex; align-items: stretch; }
                    .footer-left { width: 60%; border-right: 1px solid black; padding: 5px; display: flex; flex-direction: column; justify-content: space-between; }
                    .footer-right { width: 40%; display: flex; flex-direction: column; }

                    .bank-details-box { border: 1px solid black; padding: 5px; margin-bottom: 5px; font-size: 10px; }
                    .totals-row { display: flex; justify-content: space-between; padding: 2px 5px; border-bottom: 1px solid #ccc; }
                    .grand-total-row { display: flex; justify-content: space-between; padding: 8px 5px; background: #e9ecef; border-top: 2px solid black; border-bottom: 2px solid black; font-weight: bold; align-items: center; }

                    @media print {
                        @page { size: A4; margin: 3mm; }
                        body { padding: 0; background: white; }
                        .invoice-box { border: 2px solid black; width: 100%; max-width: none; }
                        .no-print { display: none !important; }
                    }
                </style>
                
                <div class="invoice-box">
                    <!-- Header (Top Box) -->
                    <div class="header-section">
                        <!-- Left: Seller -->
                        <div class="seller-col">
                            <div class="d-flex align-items-center mb-1 border-bottom pb-1">
                                ${business.logo_url ? `<img src="${business.logo_url}" style="width: 40px; height: 40px; object-fit: contain; margin-right: 10px;">` : ''}
                                <div class="company-name text-uppercase m-0" style="line-height: 1.1;">${business.company_name || 'My Company'}</div>
                            </div>
                            <div class="p-1" style="font-size: 10px; flex-grow: 1;">
                                <div class="fw-bold">${(business.address_line1 || '').toUpperCase()}</div>
                                ${business.address_line2 ? `<div>${business.address_line2.toUpperCase()}</div>` : ''}
                                <div>${[business.sub_district, business.district, business.state].filter(Boolean).join(', ').toUpperCase()} - ${business.pincode}</div>
                                <div class="fw-bold mt-1">M: ${business.phone || ''}</div>
                                <div class="mt-1"><span class="fw-bold">GSTIN:</span> ${business.gst_number || '-'}</div>
                                ${business.email ? `<div>Email: ${business.email}</div>` : ''}
                            </div>
                        </div>

                        <!-- Right: Receiver & Invoice Info Split -->
                        <div class="buyer-col">
                            
                            <!-- Middle: Details of Receiver + Invoice Info -->
                            <div class="receiver-details-col">
                                <!-- Receiver -->
                                <div class="mb-2">
                                    <div class="fw-bold border-bottom mb-1 pb-1">Details of Receiver (Billed To)</div>
                                    <div class="fw-bold text-uppercase">${bill.customer_name}</div>
                                    <div style="font-size: 10px;">
                                        ${bill.customer_address || ''}<br>
                                        ${bill.customer_phone ? 'Ph: ' + bill.customer_phone : ''}
                                    </div>
                                    <div class="mt-1" style="font-size: 10px;">
                                        ${bill.customer_sub_district ? `<span class="fw-bold">Tal:</span> ${bill.customer_sub_district}, ` : ''} <span class="fw-bold">State:</span> ${bill.customer_state || 'MAHARASHTRA'} ${bill.customer_pincode ? '- ' + bill.customer_pincode : ''}
                                    </div>
                                    ${bill.customer_gst_number ? `<div class="mt-1" style="font-size: 10px;"><span class="fw-bold">GSTIN:</span> ${bill.customer_gst_number}</div>` : ''}
                                </div>
                                
                                <!-- Invoice Info (Moved Here) -->
                                <div style="border-top: 1px solid black; padding-top: 5px;">
                                    <div class="invoice-title text-center" style="font-size: 14px;">TAX INVOICE</div>
                                    <table style="width: 100%; font-size: 11px;">
                                        <tr>
                                            <td class="fw-bold pe-2">Invoice No:</td>
                                            <td class="fw-bold">INV-${bill.bill_number}</td>
                                            <td class="fw-bold pe-2 text-end">Date:</td>
                                            <td class="text-end">${bill.date ? bill.date.split(' ')[0] : '-'}</td>
                                        </tr>
                                        ${bill.payment_mode ? `
                                        <tr>
                                            <td class="fw-bold pe-2">Mode:</td>
                                            <td class="text-uppercase">${bill.payment_mode}</td>
                                            <td></td><td></td>
                                        </tr>` : ''}
                                    </table>
                                </div>
                            </div>

                            <!-- Right Edge: Barcode ONLY -->
                            <div class="barcode-col">
                                <!-- Payment QR Code Box -->
                                <div id="qrcode-box" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Table -->
                                        <table class="items-table">
                        <thead>
                            <tr>
                                <th class="col-sn">S.N</th>
                                <th class="col-hsn">HSN</th>
                                <th class="col-prod text-left" style="text-align: left;">Product Name</th>
                                <th class="col-pack">Pack</th>
                                <th class="col-batch">Batch</th>
                                <th class="col-mfg">Mfg Date</th>
                                <th class="col-exp">Exp.</th>
                                <th class="col-qty text-right">Qty</th>
                                <th class="col-mrp text-right">MRP</th>
                                <th class="text-right">Rate</th>
                                <th class="text-right" style="width: 35px;">CGST %</th>
                                <th class="text-right" style="width: 35px;">SGST %</th>
                                <th class="text-right" style="width: 35px;">IGST %</th>
                                <th class="text-right" style="width: 60px;">GST Amt</th>
                                <th class="col-amt text-right">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${bill.items.map((item, index) => {
                                const taxable = parseFloat(item.price) * parseFloat(item.quantity);
                                const totalIGST = bill.items.reduce((s, i) => s + parseFloat(i.igst_amount||0), 0);
                                const isBillIGST = totalIGST > 0;

                                let cRate = '', sRate = '', iRate = '';
                                if(isBillIGST) {
                                    iRate = parseFloat(parseFloat(item.igst_rate||0).toFixed(2)) + '%';
                                } else {
                                    cRate = parseFloat(parseFloat(item.cgst_rate||item.gst_rate/2||0).toFixed(2)) + '%';
                                    sRate = parseFloat(parseFloat(item.sgst_rate||item.gst_rate/2||0).toFixed(2)) + '%';
                                }
                                
                                const totalTaxAmt = parseFloat(item.cgst_amount||0) + parseFloat(item.sgst_amount||0) + parseFloat(item.igst_amount||0);

                                return `
                                <tr>
                                    <td class="text-center">${index + 1}</td>
                                    <td>${item.hsn_number || ''}</td>
                                    <td class="fw-bold">${item.product_name}</td>
                                    <td class="text-center">${item.unit || ''}</td>
                                    <td>${item.batch_number || ''}</td>
                                    <td class="text-center">${item.mfg_date ? item.mfg_date.substring(0,7) : ''}</td>
                                    <td class="text-center">${item.expiry_date ? item.expiry_date.substring(0,7) : ''}</td>
                                    <td class="text-right fw-bold">${parseFloat(item.quantity)}</td>
                                    <td class="text-right">${parseFloat(item.mrp || 0).toFixed(2)}</td>
                                    <td class="text-right">${parseFloat(item.price).toFixed(2)}</td>
                                    <td class="text-center">${cRate}</td>
                                    <td class="text-center">${sRate}</td>
                                    <td class="text-center">${iRate}</td>
                                    <td class="text-right">${totalTaxAmt.toFixed(2)}</td>
                                    <td class="text-right fw-bold">${taxable.toFixed(2)}</td>
                                </tr>
                                `;
                            }).join('')}
                            

                        </tbody>
                    </table>



                    <!-- Layout based on user image: Flex container splitting Left (Tax/Terms) and Right (Totals) -->
                    <div style="display: flex; border-top: 2px solid black; border-bottom: 2px solid black;">
                        
                        <!-- LEFT PANE (70%) -->
                        <div style="width: 70%; border-right: 2px solid black; display: flex; flex-direction: column;">
                            
                            <!-- Tax Analysis Table -->
                            <div style="flex-grow: 1;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 10px; text-align: center;">
                                    <tr style="background: #ccc; font-weight: bold;">
                                        <td style="border-right: 1px solid black; border-bottom: 1px solid black;">CLASS</td>
                                        <td style="border-right: 1px solid black; border-bottom: 1px solid black;">BASIC</td>
                                        <td style="border-right: 1px solid black; border-bottom: 1px solid black;">DISCOUNT</td>
                                        <td style="border-right: 1px solid black; border-bottom: 1px solid black;">IGST</td>
                                        <td style="border-right: 1px solid black; border-bottom: 1px solid black;">SGST</td>
                                        <td style="border-right: 1px solid black; border-bottom: 1px solid black;">CGST</td>
                                        <td style="border-bottom: 1px solid black;">TOTAL GST</td>
                                    </tr>
                                    ${(() => {
                                        const groups = {};
                                        
                                        // 1. Initialize mandatory groups (removed to show only applied)
                                        // ['GST 12.00%', 'GST 18.00%', 'GST 28.00%'].forEach(k => {
                                        //    groups[k] = { basic: 0, igst: 0, sgst: 0, cgst: 0 };
                                        // });

                                        // 2. Aggregate actual data
                                        bill.items.forEach(item => {
                                            let label = "GST 0%";
                                            const iRate = parseFloat(item.igst_rate || 0);
                                            const cRate = parseFloat(item.cgst_rate || 0);
                                            const sRate = parseFloat(item.sgst_rate || 0);
                                            
                                            if(iRate > 0) { 
                                                label = `IGST ${parseFloat(iRate.toFixed(2))}%`; 
                                            } else if(cRate > 0 || sRate > 0) { 
                                                label = `GST ${parseFloat((cRate + sRate).toFixed(2))}%`; 
                                            }
                                            
                                            // Create if not exists (e.g. IGST 5%, or GST 5%)
                                            if(!groups[label]) groups[label] = { basic: 0, igst: 0, sgst: 0, cgst: 0 };
                                            
                                            const qty = parseFloat(item.quantity) || 0;
                                            const rateVal = parseFloat(item.price || item.rate || 0);
                                            const basicAmt = qty * rateVal;

                                            groups[label].basic += basicAmt;
                                            groups[label].igst += parseFloat(item.igst_amount||0);
                                            groups[label].sgst += parseFloat(item.sgst_amount||0);
                                            groups[label].cgst += parseFloat(item.cgst_amount||0);
                                        });
                                        
                                        // 3. Process groups: Zero out taxes for 12/18/28 and Calculate Totals
                                        let totalBasic = 0;
                                        let totalIgst = 0;
                                        let totalSgst = 0;
                                        let totalCgst = 0;
                                        let totalTaxVal = 0;

                                        const rows = Object.keys(groups).sort().map(key => {
                                            // Logic to zero out tax for 12, 18, 28 (DISABLED to show actuals)
                                            let g = groups[key];
                                            // if(key.includes('12.00') || key.includes('18.00') || key.includes('28.00')) {
                                            //     g.igst = 0;
                                            //     g.sgst = 0;
                                            //     g.cgst = 0;
                                            // }
                                            
                                            const rowTax = g.igst + g.sgst + g.cgst;

                                            // Accumulate Totals
                                            totalBasic += g.basic;
                                            totalIgst += g.igst;
                                            totalSgst += g.sgst;
                                            totalCgst += g.cgst;
                                            totalTaxVal += rowTax;

                                            // Only show if basic > 0 OR it's one of the mandatory fields we just added? 
                                            // The user asked to "ad extra records", so we show them even if 0.
                                            // Filter out non-mandatory 0 rows if any? No, keep all to be safe.
                                            
                                            return `
                                            <tr style="border-bottom: 1px solid #eee;">
                                                <td style="border-right: 1px solid black; background: #ddd; font-weight: bold; text-align: left; padding-left: 5px;">${key}</td>
                                                <td style="border-right: 1px solid black;">${g.basic.toFixed(2)}</td>
                                                <td style="border-right: 1px solid black;">0.00</td>
                                                <td style="border-right: 1px solid black;">${g.igst.toFixed(2)}</td>
                                                <td style="border-right: 1px solid black;">${g.sgst.toFixed(2)}</td>
                                                <td style="border-right: 1px solid black;">${g.cgst.toFixed(2)}</td>
                                                <td>${rowTax.toFixed(2)}</td>
                                            </tr>
                                            `;
                                        });

                                        // 4. Append Total Row based on calculated values
                                        const finalTotalRow = `
                                            <tr style="border-top: 1px solid black; font-weight: bold;">
                                                <td style="border-right: 1px solid black; text-align: left; padding-left: 5px;">TOTAL</td>
                                                <td style="border-right: 1px solid black;">${totalBasic.toFixed(2)}</td>
                                                <td style="border-right: 1px solid black;">0.00</td>
                                                <td style="border-right: 1px solid black;">${totalIgst.toFixed(2)}</td>
                                                <td style="border-right: 1px solid black;">${totalSgst.toFixed(2)}</td>
                                                <td style="border-right: 1px solid black;">${totalCgst.toFixed(2)}</td>
                                                <td>${totalTaxVal.toFixed(2)}</td>
                                            </tr>
                                        `;
                                        
                                        return rows.join('') + finalTotalRow;
                                    })()}
                                </table>
                            </div>

                            <!-- Amount Words -->
                            <div style="border-top: 1px solid black; padding: 4px 5px; font-size: 11px; font-style: italic;">
                                <span class="fw-bold text-dark" style="font-style: normal;">Amount in Words:</span> ${getAmountInWords(bill.final_amount)}
                            </div>

                            <!-- Remarks -->
                            <div style="border-top: 1px solid black; padding: 2px 5px; font-size: 10px;">
                                <span class="fw-bold">Remarks:</span> ${bill.remarks || 'M.R.P revised as per reduced GST slab, please Ensure for benefit to consumer.'}
                            </div>
                            
                            <!-- Terms & Signatory -->
                            <div style="display: flex; border-top: 1px solid black; min-height: 100px;">
                                <!-- Terms -->
                                <div style="flex: 1; border-right: 1px solid black; padding: 5px;">
                                    <div style="text-decoration: underline; font-weight: bold; font-size: 10px; margin-bottom: 2px;">Terms & Conditions</div>
                                    <ul style="padding-left: 15px; margin: 0; font-size: 9px; list-style: decimal;">
                                        ${formatTerms(business.terms_and_conditions)}
                                    </ul>
                                </div>
                                <!-- Signatory -->
                                <div style="flex: 1; padding: 5px; display: flex; flex-direction: column; justify-content: space-between; align-items: center; text-align: center; position: relative;">
                                    
                                    <!-- Watermark -->
                                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-10deg); color: rgba(0,0,0,0.1); font-size: 14px; font-weight: bold; pointer-events: none; white-space: nowrap; z-index: 0;">
                                        ${business.company_name || 'Sanjeevani Pharma'}
                                    </div>

                                    ${business.signature_url ? `<img src="${business.signature_url}" style="max-height: 50px; max-width: 120px; object-fit: contain; margin: auto 0; position: relative; z-index: 1;">` : '<div style="flex-grow:1;"></div>'}
                                    <div style="font-size: 10px; width: 100%; text-align: center; margin-top: 5px;">Authorised Signatory</div>
                                </div>
                            </div>
                        </div>

                        <!-- RIGHT PANE (30%) - Totals -->
                        <div style="width: 30%; display: flex; flex-direction: column;">
                            <div style="padding: 5px 10px; font-size: 11px; flex-grow: 1; line-height: 1.8;">
                                <div style="display: flex; justify-content: space-between; border-bottom: 1px solid #eee;">
                                    <span class="fw-bold">BASIC AMOUNT</span> 
                                    <span>${bill.items.reduce((s,i) => s + (parseFloat(i.quantity||0) * parseFloat(i.price||i.rate||0)), 0).toFixed(2)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; border-bottom: 1px solid #eee;">
                                    <span>Discount</span> 
                                    <span>${parseFloat(bill.discount || 0).toFixed(2)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; border-bottom: 1px solid #eee;">
                                    <span>Taxable Amount</span> 
                                    <span>${(bill.items.reduce((s,i) => s + (parseFloat(i.quantity||0) * parseFloat(i.price||i.rate||0)), 0) - parseFloat(bill.discount||0)).toFixed(2)}</span>
                                </div>
                                ${(() => {
                                    const igst = bill.items.reduce((s,i) => s + parseFloat(i.igst_amount||0), 0);
                                    const cgst = bill.items.reduce((s,i) => s + parseFloat(i.cgst_amount||0), 0);
                                    const sgst = bill.items.reduce((s,i) => s + parseFloat(i.sgst_amount||0), 0);
                                    let h = '';
                                    if(igst > 0) h += `<div style="display: flex; justify-content: space-between; border-bottom: 1px solid #eee;"><span>IGST Payable</span> <span>${igst.toFixed(2)}</span></div>`;
                                    if(cgst > 0) h += `<div style="display: flex; justify-content: space-between; border-bottom: 1px solid #eee;"><span>CGST Payable</span> <span>${cgst.toFixed(2)}</span></div>`;
                                    if(sgst > 0) h += `<div style="display: flex; justify-content: space-between; border-bottom: 1px solid #eee;"><span>SGST Payable</span> <span>${sgst.toFixed(2)}</span></div>`;
                                    return h;
                                })()}
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Round off</span> 
                                    <span>0.00</span>
                                </div>
                                
                                <div class="mt-3 text-start text-muted" style="font-size: 10px;">
                                    <div>Total Items: ${bill.items.length}</div>
                                    <div>Total Qty: ${bill.items.reduce((s,i)=>s+parseFloat(i.quantity||0),0)}</div>
                                </div>
                            </div>
                            
                            <!-- Grand Total Box -->
                            <div style="background: #ccc; border-top: 2px solid black; padding: 15px 10px; text-align: center; display: flex; flex-direction: column; justify-content: center;">
                                <div style="font-size: 14px;">Grand Total</div>
                                <div style="font-size: 20px; font-weight: bold;">${parseFloat(bill.final_amount).toFixed(2)}</div>
                            </div>
                        </div>
                    </div>
             `;

    document.getElementById('billDetails').innerHTML = html;

    if (business.upi_id) {
        setTimeout(() => {
            document.getElementById('qrcode-box').innerHTML = "";
            try {
                // Sanitize and Format
                const vpa = (business.upi_id || '').trim();
                const name = (business.company_name || '').trim();
                const amount = parseFloat(bill.final_amount || 0).toFixed(2);
                
                if(vpa && amount > 0) {
                    // Standard UPI Format: upi://pay?pa=...&pn=...&am=...&tn=...
                    const upiLink = `upi://pay?pa=${encodeURIComponent(vpa)}&pn=${encodeURIComponent(name)}&am=${amount}&cu=INR&tn=Bill%20${encodeURIComponent(bill.bill_number)}`;
                    
                    new QRCode(document.getElementById('qrcode-box'), {
                        text: upiLink,
                        width: 85, height: 85,
                        colorDark : "#000000", colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.M
                    });
                }
            } catch(e) { console.error("QR Error", e); }
        }, 100);
    }
}


        // --- Payment Update (Reused) ---
        function updatePaymentStatus(billId, currentStatus, currentPaid) {
            document.getElementById('updateBillId').value = billId;
            document.getElementById('updateStatus').value = currentStatus;
            document.getElementById('updatePaidAmount').value = currentPaid;
            document.getElementById('securityPassword').value = '';
            
            // Set date to today if not set
            document.getElementById('updatePaymentDate').valueAsDate = new Date();
            
            handleUpdateStatusChange();
            new bootstrap.Modal(document.getElementById('updatePaymentModal')).show();
        }

        function handleUpdateStatusChange() {
            const status = document.getElementById('updateStatus').value;
            const detailsDiv = document.getElementById('updatePaymentDetails');
            const paidAmtDiv = document.getElementById('updatePaidAmountContainer');
            
            if (status === 'Pending') {
                detailsDiv.style.display = 'none';
            } else {
                detailsDiv.style.display = 'block';
                if (status === 'Partially Paid') {
                    paidAmtDiv.style.display = 'block';
                } else {
                    paidAmtDiv.style.display = 'none';
                }
            }
        }

        function submitPaymentUpdate() {
            const billId = document.getElementById('updateBillId').value;
            const status = document.getElementById('updateStatus').value;
            const password = document.getElementById('securityPassword').value;
            
            if (!password) {
                showToast('Please enter security password', 'error');
                return;
            }

            const data = {
                status: status,
                password: password,
                mode: document.getElementById('updatePaymentMode').value,
                date: document.getElementById('updatePaymentDate').value,
                paid_amount: status === 'Partially Paid' ? document.getElementById('updatePaidAmount').value : null
            };

            fetch(`/billing/update-payment-status/${billId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('updatePaymentModal')).hide();
                    searchBills(); // Refresh
                    showToast(data.message || 'Payment status updated successfully');
                } else {
                    showToast(data.error || 'Update failed', 'error');
                }
            })
            .catch(err => showToast('Failed to update: ' + err, 'error'));
        }
        
        function showToast(message, type = 'success') {
            const toastEl = document.getElementById('liveToast');
            const icon = document.getElementById('toastIcon');
            const title = document.getElementById('toastTitle');
            const body = document.getElementById('toastMessage');
            
            body.textContent = message;
            
            // Allow multiple classes reset
            toastEl.className = 'toast'; 
            
            if(type === 'success') {
                icon.className = 'bi bi-check-circle-fill me-2 text-success';
                title.textContent = 'Success';
            } else {
                icon.className = 'bi bi-exclamation-triangle-fill me-2 text-danger';
                title.textContent = 'Error';
            }
            
            const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
            toast.show();
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

    </script>
</body>
</html>